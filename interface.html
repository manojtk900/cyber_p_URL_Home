<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ASTRAL Chat Interface â€” Typing & Avatar</title>
<style>
:root{
  --bg1:#0f0a1f; --bg2:#170f2e; --card:#1c1535;
  --accent:#6a3cff; --accent2:#936bff; --muted:#aaa4c5;
  --text:#e8e6f7; --sidebar-width:260px; --sidebar-width-collapsed:80px;
  --ease: cubic-bezier(.2,.9,.2,1);
}
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter,system-ui,Arial;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);height:100vh;overflow:hidden;display:flex;
}

/* ---------------- SIDEBAR (unchanged behaviour) ---------------- */
.sidebar{ width:var(--sidebar-width); background:rgba(255,255,255,0.03); backdrop-filter:blur(12px); border-right:1px solid rgba(255,255,255,0.08); display:flex;flex-direction:column;transition:width .25s var(--ease); position:relative; z-index:2; }
.sidebar.collapsed{ width:var(--sidebar-width-collapsed); }
.sidebar-header{ display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid rgba(255,255,255,0.06); }
.sidebar-header h1{ margin:0; font-size:18px; opacity:.95; }
.toggle-btn{ background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;width:36px;height:36px;border-radius:8px; }

/* menu */
.menu{ flex:1; overflow-y:auto; padding:12px; }
.menu-section{ margin-bottom:16px; }
.menu-title{ font-size:12px; text-transform:uppercase; color:var(--muted); margin-bottom:8px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; user-select:none; }
.menu-title .label{ display:inline-flex; align-items:center; gap:8px; }
.menu-title .symbol{ width:28px; text-align:center; font-size:18px; }
.section-body{ overflow:hidden; transition:max-height .32s var(--ease), opacity .28s var(--ease), transform .28s var(--ease); transform-origin:top left; }
.section-body.collapsed{ max-height:0; opacity:0; transform:translateY(-6px); padding:0; margin:0; }
.section-body.open{ max-height:800px; opacity:1; transform:translateY(0); }
.menu-item{ display:flex; align-items:center; gap:10px; padding:9px 10px; border-radius:8px; cursor:pointer; color:var(--text); transition:transform .12s var(--ease), box-shadow .12s var(--ease), background .12s; user-select:none; }
.menu-item:hover{ background:rgba(255,255,255,0.03); transform:translateY(-2px); }
.menu-item:active{ transform:scale(.98); box-shadow:0 6px 18px rgba(0,0,0,0.45); }
.menu-item i{ font-size:16px; width:22px; text-align:center; }
.sidebar.collapsed .menu-item span{ display:none; }
.sidebar.collapsed .menu-title .text{ display:none; }

/* panels */
.panel{ background:rgba(255,255,255,0.04); border-radius:8px; padding:10px; margin-bottom:12px; position:relative; transition:transform .22s var(--ease); }
.panel-title{ display:flex; justify-content:space-between; cursor:pointer; font-size:14px; color:var(--accent2); user-select:none; }
.panel-content{ display:none; margin-top:8px; opacity:0; transform:translateY(-6px); transition:opacity .28s var(--ease), transform .28s var(--ease); }
.panel.open .panel-content{ display:block; opacity:1; transform:translateY(0); }

/* ---------------- CHAT AREA ---------------- */
.chat-area{ flex:1; display:flex; flex-direction:column; height:100%; }
.chat-window{ flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; }

/* message row layout */
.msg-row{ display:flex; gap:12px; align-items:flex-start; max-width:80%; }
.msg-row.from-bot{ align-self:flex-start; }
.msg-row.from-user{ align-self:flex-end; flex-direction:row-reverse; }

/* avatar */
.bot-avatar{
  width:38px; height:38px; border-radius:999px; background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex; align-items:center; justify-content:center; color:white; font-weight:700; flex-shrink:0;
  box-shadow:0 6px 22px rgba(106,60,255,0.12), 0 2px 6px rgba(0,0,0,0.35);
  animation:avatar-bob 3.5s ease-in-out infinite;
}
@keyframes avatar-bob{
  0%{ transform:translateY(0) scale(1); box-shadow:0 6px 22px rgba(106,60,255,0.10);}
  50%{ transform:translateY(-3px) scale(1.01); box-shadow:0 12px 30px rgba(106,60,255,0.12); }
  100%{ transform:translateY(0) scale(1); }
}
/* small glow pulse behind avatar */
.bot-avatar::after{
  content:""; position:absolute; width:62px; height:62px; border-radius:999px; z-index:-1; opacity:0.06;
  background:radial-gradient(circle, rgba(106,60,255,0.22), transparent 40%);
  filter:blur(8px);
}

/* message bubble */
.msg{
  padding:12px 14px; border-radius:12px; line-height:1.45; word-break:break-word; max-width:720px; white-space:pre-wrap;
}
.msg.bot{ background:rgba(255,255,255,0.06); color:var(--text); border:1px solid rgba(255,255,255,0.02); }
.msg.user{ background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white; border:none; }

/* typing indicator row (bot) */
.typing-row{ display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px; padding:6px 0; }
.typing-avatar{ width:38px; height:38px; border-radius:999px; background:linear-gradient(135deg,var(--accent),var(--accent2)); opacity:0.95; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; flex-shrink:0; animation:avatar-bob 3.5s ease-in-out infinite; }
.typing-dots{ display:inline-flex; gap:6px; align-items:center; padding:8px 12px; background:rgba(255,255,255,0.03); border-radius:999px; min-width:72px; justify-content:center; }
.typing-dots .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,0.6); opacity:0.9; transform:translateY(0); animation:dot-bounce 1s infinite; }
.typing-dots .dot:nth-child(2){ animation-delay:.12s; }
.typing-dots .dot:nth-child(3){ animation-delay:.24s; }
@keyframes dot-bounce{ 0%{ transform:translateY(0); opacity:.6 } 40%{ transform:translateY(-6px); opacity:1 } 80%{ transform:translateY(0); opacity:.6 } }

/* typing status area (above input) */
.typing-status{ display:flex; align-items:center; gap:10px; padding:10px 16px; border-top:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); color:var(--muted); font-size:13px; min-height:44px; }

/* input bar */
.input-bar{ padding:12px; display:flex; gap:10px; border-top:1px solid rgba(255,255,255,0.1); background:var(--bg2); }
.input-bar input{ flex:1; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.05); color:var(--text); outline:none; transition:box-shadow .12s; }
.input-bar input:focus{ box-shadow:0 8px 24px rgba(106,60,255,0.06); }
.input-bar button{ padding:12px 18px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; transition:transform .12s; }

/* small history item */
.history-item{ padding:8px; margin:6px 0; border-radius:6px; background:rgba(255,255,255,0.03); cursor:pointer; transition:transform .12s, background .12s; }
.history-item:hover{ background:rgba(255,255,255,0.05); transform:translateX(4px); }

/* responsive */
@media (max-width:800px){ :root{ --sidebar-width:220px; --sidebar-width-collapsed:64px; } .msg{ max-width:66vw; } }
::-webkit-scrollbar{width:8px;} ::-webkit-scrollbar-thumb{background:#3a2d5c;border-radius:4px;}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar" aria-label="Main sidebar">
  <div class="sidebar-header">
    <h1 class="title">ASTRAL</h1>
    <button id="toggleBtn" class="toggle-btn" onclick="toggleSidebar()" aria-expanded="true" title="Toggle sidebar">â‰¡</button>
  </div>

  <div class="menu">
    <!-- Chat controls -->
    <div class="menu-section" id="chatControlsSection">
      <div class="menu-title" onclick="noop()" aria-expanded="true">
        <span class="label"><span class="symbol">ï¼‹</span><span class="text">Chat Controls</span></span>
      </div>
      <div class="section-body open" id="chatControlsSection-body">
        <div class="menu-item" onclick="newChat()" role="button"><i>âœš</i><span>New Chat</span></div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="menu-section" id="historySection">
      <div class="menu-title" role="button" onclick="mainGroupClick('historySection')" aria-expanded="false">
        <span class="label"><span class="symbol">ğŸ“œ</span><span class="text">History</span></span>
      </div>
      <div class="section-body collapsed" id="historySection-body">
        <div id="historyList"></div>
      </div>
    </div>

    <!-- QUICK QUESTIONS -->
    <div class="menu-section" id="quickSection">
      <div class="menu-title" role="button" onclick="mainGroupClick('quickSection')" aria-expanded="false">
        <span class="label"><span class="symbol">â“</span><span class="text">Quick Questions</span></span>
      </div>
      <div class="section-body collapsed" id="quickSection-body">
        <!-- 30+ categorized quick questions (calls existing quickQuestionClicked) -->
        <!-- Email & General -->
        <div class="menu-item" onclick="quickQuestionClicked('What is phishing?')"><i>ğŸ“§</i><span>What is phishing?</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Phishing signs in email')"><i>âš ï¸</i><span>Phishing signs in email</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('How to verify email sender')"><i>ğŸ”</i><span>Verify email sender</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Check suspicious attachments')"><i>ğŸ“</i><span>Check suspicious attachments</span></div>

        <!-- URLs & Links -->
        <div class="menu-item" onclick="quickQuestionClicked('Is this link safe?')"><i>ğŸ”—</i><span>Is this link safe?</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('How to verify a website')"><i>ğŸŒ</i><span>How to verify a website</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Check short links safely')"><i>âœ‚ï¸</i><span>Check short links safely</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('URL red flags')"><i>ğŸš©</i><span>URL red flags</span></div>

        <!-- Banking & Payments -->
        <div class="menu-item" onclick="quickQuestionClicked('Bank fraud warning')"><i>ğŸ¦</i><span>Bank fraud warning</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('UPI fraud signs')"><i>ğŸ’¸</i><span>UPI fraud signs</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('What to do if money sent')"><i>ğŸ†˜</i><span>What to do if money sent</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Fake payment requests')"><i>ğŸ“²</i><span>Fake payment requests</span></div>

        <!-- SMS / WhatsApp (Smishing) -->
        <div class="menu-item" onclick="quickQuestionClicked('SMS phishing signs')"><i>ğŸ“±</i><span>SMS / WhatsApp phishing signs</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('How to handle suspicious SMS')"><i>âœ‰ï¸</i><span>Handle suspicious SMS</span></div>

        <!-- Phone scams (Vishing) -->
        <div class="menu-item" onclick="quickQuestionClicked('Fake customer support scams')"><i>â˜ï¸</i><span>Fake customer support scams</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Vishing (phone) scams')"><i>ğŸ“</i><span>Vishing (phone) scams</span></div>

        <!-- Social Media -->
        <div class="menu-item" onclick="quickQuestionClicked('Social media hacking signs')"><i>ğŸ›¡ï¸</i><span>Social media hacking signs</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Recognize scam messages on social')"><i>ğŸ’¬</i><span>Recognize social scam messages</span></div>

        <!-- Job & Recruitment Scams -->
        <div class="menu-item" onclick="quickQuestionClicked('Avoid fake job offers')"><i>ğŸ’¼</i><span>Avoid fake job offers</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Job scam red flags')"><i>ğŸš«</i><span>Job scam red flags</span></div>

        <!-- Account Security -->
        <div class="menu-item" onclick="quickQuestionClicked('Safe password tips')"><i>ğŸ”</i><span>Safe password tips</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Two-factor auth')"><i>ğŸ”</i><span>Two-factor auth</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('What to do if hacked')"><i>ğŸ”‘</i><span>What to do if hacked</span></div>

        <!-- Scams & Examples -->
        <div class="menu-item" onclick="quickQuestionClicked('Common phishing examples')"><i>ğŸ§ª</i><span>Common phishing examples</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('CEO fraud / Business email compromise')"><i>ğŸ¢</i><span>CEO fraud / BEC</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Investment & refund scams')"><i>ğŸ’°</i><span>Investment & refund scams</span></div>

        <!-- Reporting & Help -->
        <div class="menu-item" onclick="quickQuestionClicked('How to report cybercrime')"><i>ğŸš¨</i><span>How to report cybercrime</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Evidence to collect before reporting')"><i>ğŸ“‚</i><span>Evidence to collect</span></div>

        <!-- Technical & Model -->
        <div class="menu-item" onclick="quickQuestionClicked('How detection works')"><i>âš™ï¸</i><span>How detection works</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('What the model checks')"><i>ğŸ”¬</i><span>What the model checks</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Why model might be wrong')"><i>â“</i><span>Why model might be wrong</span></div>

        <!-- Misc / Tips -->
        <div class="menu-item" onclick="quickQuestionClicked('How to stay safe online')"><i>ğŸ›¡</i><span>How to stay safe online</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Recognize scam messages')"><i>ğŸ“²</i><span>Recognize scam messages</span></div>
        <div class="menu-item" onclick="quickQuestionClicked('Check browser popups and QR code scams')"><i>ğŸ”</i><span>Browser popups & QR scams</span></div>
      </div>
    </div>

    <!-- Panels -->
    <div class="panel" id="panelModel">
      <div class="panel-title" onclick="togglePanel('panelModel')">Model Info <span>â–¼</span></div>
      <div class="panel-content">
        <div>Vector Loaded: <span id="vecLoaded">â€”</span></div>
        <div>Model Loaded: <span id="mdlLoaded">â€”</span></div>
        <div>Model Type: <span id="mdlType">â€”</span></div>
      </div>
    </div>

    <div class="panel" id="panelCheck">
      <div class="panel-title" onclick="togglePanel('panelCheck')">Quick URL Check <span>â–¼</span></div>
      <div class="panel-content">
        <input id="quickUrl" placeholder="https://example.com" style="width:100%;padding:8px;border-radius:6px;border:none;margin-bottom:6px;background:rgba(255,255,255,0.03);color:var(--text);">
        <button onclick="quickCheck()" style="width:100%;padding:8px;border-radius:6px;border:none;background:var(--accent);color:white;">Check</button>
        <div id="quickResult" style="margin-top:8px;font-size:13px;"></div>
      </div>
    </div>

    <div class="panel" id="panelAdmin">
      <div class="panel-title" onclick="togglePanel('panelAdmin')">Admin <span>â–¼</span></div>
      <div class="panel-content">
        <button onclick="reloadModel()" style="width:100%;padding:8px;border-radius:6px;border:none;background:var(--accent);color:white;">Reload Model</button>
      </div>
    </div>

  </div>
</div>

<!-- CHAT AREA -->
<div class="chat-area">
  <div id="chatWindow" class="chat-window" role="log" aria-live="polite">
    <!-- Example initial bot message -->
    <div class="msg-row from-bot">
      <div class="bot-avatar" aria-hidden="true">A</div>
      <div class="msg bot">Hello! I am Astral Assistant. How can I help?</div>
    </div>
  </div>

  <!-- typing status (appears when bot is typing) -->
  <div id="typingStatus" class="typing-status" style="display:none;">
    <div class="typing-avatar" aria-hidden="true">A</div>
    <div style="display:flex;flex-direction:column;">
      <div style="font-weight:600;color:var(--text)">Astral Assistant</div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
        <div class="typing-dots" aria-hidden="true">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <div style="font-size:13px;color:var(--muted)">Bot is typingâ€¦</div>
      </div>
    </div>
  </div>

  <div class="input-bar">
    <input id="chatInput" placeholder="Type your messageâ€¦" aria-label="Chat message">
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
/* ---------------- State ---------------- */
const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggleBtn');

let history = [];
const chatWindow = document.getElementById('chatWindow');
const chatInput = document.getElementById('chatInput');
const typingStatus = document.getElementById('typingStatus');

const TYPING_SIM_DELAY = 450;    // how long to show "typing" before streaming begins (ms)
const TYPING_CHAR_MS = 18;      // ms per character for typing animation (adjust for speed)
let currentStreaming = null;    // reference to current streaming interval (so we can cancel)

/* ---------------- Utilities ---------------- */
function noop(){}

/* ---------------- Sidebar / Groups / Panels (same behaviours) ---------------- */
function toggleSidebar(){
  const collapsed = sidebar.classList.toggle('collapsed');
  toggleBtn.setAttribute('aria-expanded', String(!collapsed));
  toggleBtn.innerText = collapsed ? 'Â»' : 'â‰¡';
  if(collapsed){
    closeAllGroups();
    closeAllPanels();
  }
}

function mainGroupClick(sectionId){
  const wasCollapsed = sidebar.classList.contains('collapsed');
  if(wasCollapsed){
    sidebar.classList.remove('collapsed');
    toggleBtn.innerText = 'â‰¡';
    toggleBtn.setAttribute('aria-expanded','true');
    setTimeout(()=> openOnlySection(sectionId), 140);
  } else {
    const body = document.getElementById(sectionId + '-body');
    if(body.classList.contains('open')) collapseSection(sectionId);
    else openOnlySection(sectionId);
  }
}

function openOnlySection(sectionId){
  document.querySelectorAll('.section-body').forEach(sb=>{
    if(sb.id === sectionId + '-body'){
      sb.classList.remove('collapsed');
      sb.classList.add('open');
      sb.previousElementSibling?.setAttribute('aria-expanded','true');
    } else {
      sb.classList.remove('open');
      sb.classList.add('collapsed');
      sb.previousElementSibling?.setAttribute('aria-expanded','false');
    }
  });
  closeAllPanels();
}

function collapseSection(sectionId){
  const sb = document.getElementById(sectionId + '-body');
  if(sb){ sb.classList.remove('open'); sb.classList.add('collapsed'); sb.previousElementSibling?.setAttribute('aria-expanded','false'); }
}
function closeAllGroups(){ document.querySelectorAll('.section-body').forEach(sb=>{ sb.classList.remove('open'); sb.classList.add('collapsed'); sb.previousElementSibling?.setAttribute('aria-expanded','false'); }); }

function togglePanel(id){
  const p = document.getElementById(id);
  p.classList.toggle('open');
  document.querySelectorAll('.panel').forEach(other=>{
    if(other.id !== id) other.classList.remove('open');
  });
  if(p.classList.contains('open')) closeAllGroups();
}
function closeAllPanels(){ document.querySelectorAll('.panel').forEach(p=>p.classList.remove('open')); }

/* ---------------- History ---------------- */
function addHistoryItem(text){
  history.unshift(text);
  const zone = document.getElementById('historyList');
  const d = document.createElement('div');
  d.className = 'history-item';
  d.innerText = text.length>40? text.slice(0,40)+'â€¦' : text;
  d.onclick = ()=> {
    addMessage("(From history) "+text, "user");
    // send to backend to get response
    sendToBackend(text);
  };
  zone.prepend(d);
}

/* ---------------- Chat messaging & streaming ---------------- */

/* helper: create bot message row and return the message bubble element */
function createBotMessagePlaceholder(){
  const row = document.createElement('div');
  row.className = 'msg-row from-bot';
  // avatar
  const avatar = document.createElement('div');
  avatar.className = 'bot-avatar';
  avatar.setAttribute('aria-hidden','true');
  avatar.innerText = 'A';
  // bubble
  const bubble = document.createElement('div');
  bubble.className = 'msg bot';
  bubble.innerText = ''; // filled during streaming
  row.appendChild(avatar);
  row.appendChild(bubble);
  chatWindow.appendChild(row);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return bubble;
}

/* show typing status area */
function showTypingStatus(){
  typingStatus.style.display = 'flex';
  // scroll so typing is visible
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

/* hide typing status area */
function hideTypingStatus(){
  typingStatus.style.display = 'none';
}

/* animate the received reply by typing it into the bubble */
function streamReplyIntoBubble(replyText, bubbleEl){
  // Cancel any existing streaming
  if(currentStreaming) {
    clearInterval(currentStreaming);
    currentStreaming = null;
  }
  let i = 0;
  const len = replyText.length;
  // small per-character interval tuned by TYPING_CHAR_MS
  return new Promise((resolve)=>{
    currentStreaming = setInterval(()=>{
      // append a chunk to reduce interval overhead; choose chunk size proportional to speed
      const chunkSize = 1;
      i += chunkSize;
      if(i > len) i = len;
      bubbleEl.innerText = replyText.slice(0, i);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      if(i >= len){
        clearInterval(currentStreaming);
        currentStreaming = null;
        resolve();
      }
    }, TYPING_CHAR_MS);
  });
}

/* central backend call that shows typing and streams reply */
async function sendToBackend(userMessage){
  // Show typing status first
  showTypingStatus();

  try{
    // call backend
    const r = await fetch('/chat_api', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: userMessage})
    });

    // If server returned non-JSON, handle gracefully
    if(!r.ok){
      const errText = `Server error ${r.status}`;
      hideTypingStatus();
      addMessage("Error: "+errText, "bot"); // show as bot message
      return;
    }

    // attempt to parse JSON
    const j = await r.json();
    const reply = j.reply || j?.message || "No reply";

    // small delay to feel like "thinking" (optional)
    await new Promise(res => setTimeout(res, TYPING_SIM_DELAY));

    // create placeholder bubble and stream
    const bubble = createBotMessagePlaceholder();
    await streamReplyIntoBubble(reply, bubble);

    // done streaming
    hideTypingStatus();

  }catch(err){
    hideTypingStatus();
    addMessage("Error: "+err.message, "bot");
  }
}

/* adding a user message bubble */
function addMessage(text, sender){
  if(sender === 'user'){
    // user row
    const row = document.createElement('div');
    row.className = 'msg-row from-user';
    const bubble = document.createElement('div');
    bubble.className = 'msg user';
    bubble.innerText = text;
    row.appendChild(bubble);
    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  } else {
    // bot immediate (used for errors / fallback), create simple row with avatar
    const row = document.createElement('div');
    row.className = 'msg-row from-bot';
    const avatar = document.createElement('div');
    avatar.className = 'bot-avatar';
    avatar.setAttribute('aria-hidden','true');
    avatar.innerText = 'A';
    const bubble = document.createElement('div');
    bubble.className = 'msg bot';
    bubble.innerText = text;
    row.appendChild(avatar);
    row.appendChild(bubble);
    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
}

/* actual send message handler (user triggers) */
function sendMessage(){
  const msg = chatInput.value.trim();
  if(!msg) return;
  // show user's message immediately in chat and history
  addMessage(msg, 'user');
  addHistoryItem(msg);
  chatInput.value = '';
  chatInput.focus();

  // call backend which will show typing status + streaming
  sendToBackend(msg);
}

/* Quick questions that auto-send */
function quickQuestionClicked(questionText){
  const wasCollapsed = sidebar.classList.contains('collapsed');
  if(wasCollapsed){
    sidebar.classList.remove('collapsed');
    toggleBtn.innerText = 'â‰¡';
    toggleBtn.setAttribute('aria-expanded','true');
    setTimeout(()=>{
      openOnlySection('quickSection');
      // simulate send
      chatInput.value = questionText;
      sendMessage();
    }, 140);
  } else {
    openOnlySection('quickSection');
    chatInput.value = questionText;
    sendMessage();
  }
}

/* helper existing behaviours (groups/panels) */
function openOnlySection(sectionId){
  document.querySelectorAll('.section-body').forEach(sb=>{
    if(sb.id === sectionId + '-body'){
      sb.classList.remove('collapsed');
      sb.classList.add('open');
      sb.previousElementSibling?.setAttribute('aria-expanded','true');
    } else {
      sb.classList.remove('open');
      sb.classList.add('collapsed');
      sb.previousElementSibling?.setAttribute('aria-expanded','false');
    }
  });
  closeAllPanels();
}
function collapseSection(sectionId){ const sb = document.getElementById(sectionId + '-body'); if(sb){ sb.classList.remove('open'); sb.classList.add('collapsed'); sb.previousElementSibling?.setAttribute('aria-expanded','false'); } }
function closeAllGroups(){ document.querySelectorAll('.section-body').forEach(sb=>{ sb.classList.remove('open'); sb.classList.add('collapsed'); sb.previousElementSibling?.setAttribute('aria-expanded','false'); }); }
function togglePanel(id){ const p = document.getElementById(id); p.classList.toggle('open'); document.querySelectorAll('.panel').forEach(other=>{ if(other.id !== id) other.classList.remove('open'); }); if(p.classList.contains('open')) closeAllGroups(); }
function closeAllPanels(){ document.querySelectorAll('.panel').forEach(p=>p.classList.remove('open')); }

/* history click: send to backend for reply */
function addHistoryItemClickable(text){
  history.unshift(text);
  const zone = document.getElementById('historyList');
  const d = document.createElement('div');
  d.className = 'history-item';
  d.innerText = text.length>40? text.slice(0,40)+'â€¦' : text;
  d.onclick = ()=> {
    addMessage("(From history) "+text, "user");
    sendToBackend(text);
  };
  zone.prepend(d);
}
/* keep addHistoryItem helper for previous naming compatibility */
function addHistoryItem(text){ addHistoryItemClickable(text); }

/* ---------------- Quick URL & model info (unchanged) ---------------- */
async function loadModelInfo(){
  try{ const r = await fetch('/admin/model-info'); if(!r.ok) return; const j = await r.json(); document.getElementById("vecLoaded").innerText = j.vector_loaded ? "Yes":"No"; document.getElementById("mdlLoaded").innerText = j.model_loaded ? "Yes":"No"; document.getElementById("mdlType").innerText = j.meta?.model_type || "â€”"; }catch(e){}
}
loadModelInfo();
async function quickCheck(){
  const url = document.getElementById('quickUrl').value.trim();
  if(!url){ document.getElementById('quickResult').innerText="Enter a URL"; return; }
  try{ const r = await fetch('/api/check_url',{ method:'POST', headers:{"Content-Type":"application/json"}, body:JSON.stringify({url}) }); const j = await r.json(); document.getElementById('quickResult').innerHTML = "<b>"+j.message+"</b>"; }catch(e){ document.getElementById('quickResult').innerText = "Error: "+e.message; }
}
async function reloadModel(){ const token = prompt("Enter admin token:"); if(!token) return; try{ const r = await fetch('/admin/reload-model',{ method:'POST', headers:{'Authorization':'Bearer '+token} }); const j = await r.json(); alert(JSON.stringify(j)); loadModelInfo(); }catch(e){ alert("Reload error: "+e.message); } }

/* enter-to-send */
chatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

/* on load focus input */
chatInput.focus();
</script>
</body>
</html>
